name: 'New deployment tool'
description: 'Deploy your project with ease'

inputs:
  github_token:
    description: 'GITHUB_TOKEN or a repo scoped PAT.'
    default: ${{ github.token }}
  version:
    description: 'Version of the CLI to use.'
    default: 'alpha' # using branch name for now for easier deployments 
  deploy_commands:
    description: 'List of commands to run to deploy your project.'
    required: true
    default: ''
  analyze_commits_config:
    description: 'Configure the behavior when analyzing commits.'
    default: ''
  enable_test_mode_squash_method:
    description: 'When running in a pull request, enables test mode to make sure that tool is setup correctly and tells you what version will be deployed if pull request is merged using the *Squash and merge* button. Value is string values "true" or "false".'
    default: 'false'
  enable_test_mode_rebase_method:
    description: 'When running in a pull request, enables test mode to make sure that tool is setup correctly and tells you what version will be deployed if pull request is merged using the *Rebase and merge* button. Value is string values "true" or "false".'
    default: 'false'  
  enable_test_mode_merge_method:
    description: 'When running in a pull request, enables test mode to make sure that tool is setup correctly and tells you what version will be deployed if pull request is merged using the *Merge pull request* button. Value is string values "true" or "false".'
    default: 'true'
  make_pull_request_comment:
    description: 'If a pull request comment should be made. Value is string values "true" or "false".'
    default: 'true'

outputs:
  new_release_version:
    description: 'If a new release was created, this is the version of that release.'
    value: ${{ steps.deployment.outputs.new_release_version }}
  test_mode_on:
    description: 'If test mode was on when the tool ran. Value is string values "true" or "false".'
    value: ${{ steps.deployment.outputs.test_mode_on }}

runs:
  using: "composite"
  steps:
    - name: Install Deno runtime to run the CLI
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x

    - name: Compile the CLI
      run: deno task compile
      shell: bash

    - name: Find pull request comment previously created, if there is one. 
      if: ${{ github.event_name == 'pull_request' }}
      uses: peter-evans/find-comment@v3
      id: find-comment
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: '<!-- new-deployment-tool-deploy-run-output -->'
        token: ${{ inputs.github_token }}  
        
    - name: Create or update pull request comment with new deployment tool output
      uses: peter-evans/create-or-update-comment@v4
      id: create-or-update-comment
      if: ${{ github.event_name == 'pull_request' && inputs.make_pull_request_comment == 'true' }}
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          <!-- new-deployment-tool-deploy-run-output -->
          ## New deployment tool
          Running deployments in test mode. Results will appear below. 

          If this pull request and all of it's parent pull requests are merged using the...
        edit-mode: replace

    #######################
    # Run the tool. 
    #######################

    # Here we run it, if in production. 
    - name: Run deployment tool 
      # Deno's runtime permissions are a great feature. It would be nice to take advantage of it, however, it may not be possible with future features like running plugins. 
      #
      # The directories we are giving permission to read and write to are the temp directories for all of the OSes that GitHub Actions supports. /tmp for linux and /var/folders for macOS.
      run: ./deployer
      id: deployment
      if: ${{ github.event_name != 'pull_request' }}
      shell: bash 
      env:
        INPUT_GITHUB_TOKEN: ${{ inputs.github_token }}
        INPUT_DEPLOY_COMMANDS: ${{ inputs.deploy_commands }}
        INPUT_ANALYZE_COMMITS_CONFIG: ${{ inputs.analyze_commits_config }}    

    #######################
    # Run tool in test mode. Every simulated merge type. 
    #######################

    # Merge simulated merge    

    - name: Run deployment tool in test mode with 'merge' simulated merge 
      run: ./deployer
      id: deployment-merge
      if: ${{ github.event_name == 'pull_request' && inputs.enable_test_mode_merge_method == 'true' }}
      shell: bash 
      env:
        INPUT_SIMULATED_MERGE_TYPE: 'merge'
        INPUT_GITHUB_TOKEN: ${{ inputs.github_token }}
        INPUT_DEPLOY_COMMANDS: ${{ inputs.deploy_commands }}
        INPUT_ANALYZE_COMMITS_CONFIG: ${{ inputs.analyze_commits_config }}

    - name: Comment merge method results 
      uses: peter-evans/create-or-update-comment@v4
      if: ${{ inputs.make_pull_request_comment == 'true' && steps.deployment-merge.outcome == 'success' && steps.deployment-merge.outputs.new_release_version != '' }}
      with:
        comment-id: ${{ steps.create-or-update-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          - ...游릴 **merge** 游릴 merge method... 游뚹 The next version of the project will be: **${{ steps.deployment-merge.outputs.new_release_version }}**
        edit-mode: append

    - name: Comment merge method results 
      uses: peter-evans/create-or-update-comment@v4
      if: ${{ inputs.make_pull_request_comment == 'true' && steps.deployment-merge.outputs.test_mode_on == 'true' && steps.deployment-merge.outcome == 'success' && steps.deployment-merge.outputs.new_release_version == '' }}
      with:
        comment-id: ${{ steps.create-or-update-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          - ...游릴 **merge** 游릴 merge method... 游꺖 It will not trigger a deployment. No new version will be deployed. 
        edit-mode: append

    - name: Comment merge method results 
      uses: peter-evans/create-or-update-comment@v4
      if: ${{ inputs.make_pull_request_comment == 'true' && steps.deployment-merge.outputs.test_mode_on == 'true' && steps.deployment-merge.outcome != 'success' }}
      with:
        comment-id: ${{ steps.create-or-update-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          - ...游릴 **merge** 游릴 merge method... 丘멆잺 There was an error during deployment run. [See logs to learn more and fix the issue](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}). 
        edit-mode: append

    # Squash simulated merge

    - name: Reset the repo to cleanup from last simulated merge
      uses: actions/checkout@v4

    - name: Compile the CLI
      run: deno task compile
      shell: bash

    - name: Run deployment tool in test mode with 'squash' simulated merge 
      run: ./deployer
      id: deployment-squash
      if: ${{ github.event_name == 'pull_request' && inputs.enable_test_mode_squash_method == 'true' }}
      shell: bash 
      env:
        INPUT_SIMULATED_MERGE_TYPE: 'squash'
        INPUT_GITHUB_TOKEN: ${{ inputs.github_token }}
        INPUT_DEPLOY_COMMANDS: ${{ inputs.deploy_commands }}
        INPUT_ANALYZE_COMMITS_CONFIG: ${{ inputs.analyze_commits_config }}

    - name: Comment squash method results 
      uses: peter-evans/create-or-update-comment@v4
      if: ${{ inputs.make_pull_request_comment == 'true' && steps.deployment-squash.outcome == 'success' && steps.deployment-squash.outputs.new_release_version != '' }}
      with:
        comment-id: ${{ steps.create-or-update-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          - ...游릴 **squash** 游릴 merge method... 游뚹 The next version of the project will be: **${{ steps.deployment-merge.outputs.new_release_version }}**
        edit-mode: append

    - name: Comment squash method results 
      uses: peter-evans/create-or-update-comment@v4
      if: ${{ inputs.make_pull_request_comment == 'true' && steps.deployment-squash.outputs.test_mode_on == 'true' && steps.deployment-squash.outcome == 'success' && steps.deployment-squash.outputs.new_release_version == '' }}
      with:
        comment-id: ${{ steps.create-or-update-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          - ...游릴 **squash** 游릴 merge method... 游꺖 It will not trigger a deployment. No new version will be deployed. 
        edit-mode: append

    - name: Comment squash method results 
      uses: peter-evans/create-or-update-comment@v4
      if: ${{ inputs.make_pull_request_comment == 'true' && steps.deployment-squash.outputs.test_mode_on == 'true' && steps.deployment-squash.outcome != 'success' }}
      with:
        comment-id: ${{ steps.create-or-update-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          - ...游릴 **squash** 游릴 merge method... 丘멆잺 There was an error during deployment run. [See logs to learn more and fix the issue](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}). 
        edit-mode: append

    # Rebase simulated merge

    - name: Reset the repo to cleanup from last simulated merge
      uses: actions/checkout@v4

    - name: Compile the CLI
      run: deno task compile
      shell: bash

    - name: Run deployment tool in test mode with 'rebase' simulated merge 
      run: ./deployer
      id: deployment-rebase
      if: ${{ github.event_name == 'pull_request' && inputs.enable_test_mode_rebase_method == 'true' }}
      shell: bash 
      env:
        INPUT_SIMULATED_MERGE_TYPE: 'rebase'
        INPUT_GITHUB_TOKEN: ${{ inputs.github_token }}
        INPUT_DEPLOY_COMMANDS: ${{ inputs.deploy_commands }}
        INPUT_ANALYZE_COMMITS_CONFIG: ${{ inputs.analyze_commits_config }}

    - name: Comment rebase method results 
      uses: peter-evans/create-or-update-comment@v4
      if: ${{ inputs.make_pull_request_comment == 'true' && steps.deployment-rebase.outcome == 'success' && steps.deployment-rebase.outputs.new_release_version != '' }}
      with:
        comment-id: ${{ steps.create-or-update-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          - ...游릴 **rebase** 游릴 merge method... 游뚹 The next version of the project will be: **${{ steps.deployment-merge.outputs.new_release_version }}**
        edit-mode: append

    - name: Comment rebase method results 
      uses: peter-evans/create-or-update-comment@v4
      if: ${{ inputs.make_pull_request_comment == 'true' && steps.deployment-rebase.outputs.test_mode_on == 'true' && steps.deployment-rebase.outcome == 'success' && steps.deployment-rebase.outputs.new_release_version == '' }}
      with:
        comment-id: ${{ steps.create-or-update-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          - ...游릴 **rebase** 游릴 merge method... 游꺖 It will not trigger a deployment. No new version will be deployed. 
        edit-mode: append

    - name: Comment rebase method results 
      uses: peter-evans/create-or-update-comment@v4
      if: ${{ inputs.make_pull_request_comment == 'true' && steps.deployment-rebase.outputs.test_mode_on == 'true' && steps.deployment-rebase.outcome != 'success' }}
      with:
        comment-id: ${{ steps.create-or-update-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          - ...游릴 **rebase** 游릴 merge method... 丘멆잺 There was an error during deployment run. [See logs to learn more and fix the issue](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}). 
        edit-mode: append

    #######################


