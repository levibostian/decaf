version: 2.1
orbs:
  gh: circleci/github-cli@2.6
jobs:
  build:
    machine:
      image: ubuntu-2404:2024.11.1
    steps:
      - checkout
      - gh/install
      - run: curl -fsSL https://deno.land/install.sh | sh
      - run:
          name: Add Deno to PATH
          command: echo 'export PATH="/home/circleci/.deno/bin:$PATH"' >> $BASH_ENV

      # Install a specific version of the tool (recommended for teams)
      # - run: curl -fsSL https://github.com/levibostian/decaf/blob/HEAD/install?raw=true | bash "1.0.0"
      # --- 
      # To always install the latest version (not recommended for teams):
      # - run: curl -fsSL https://github.com/levibostian/decaf/blob/HEAD/install?raw=true | bash

      # Compile and run so we can test the recent code changes in project. 
      # This is used for development purposes only.
      - run: 
          name: Compile binary
          command: OUTPUT_FILE_NAME=decaf DENO_TARGET="$(uname -m)-unknown-linux-gnu" deno task compile

      - run:
          name: Run CLI Tool
          command: |
            ./decaf \
              --github_token "$GH_TOKEN" \
              --deploy "./steps/deploy.ts" \
              --get_latest_release_current_branch "./steps/get-latest-release.ts" \
              --get_next_release_version "./steps/get-next-release.ts" \
              --simulated_merge_type "rebase" \
              --make_pull_request_comment false \
              --debug_file "/tmp/decaf.log" 
       
      - store_artifacts:
          path: /tmp/decaf.log
          destination: debug-logs
          when: always 

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
