#!/usr/bin/env bash
set -euo pipefail

REPO="levibostian/decaf"
BINARY_NAME="decaf"

echo "Fetching latest release version from GitHub..."
LATEST=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name":' | sed 's/.*"tag_name": *"\([^"]*\)".*/\1/')

# Detect platform
OS=$(uname -s)
ARCH=$(uname -m)

# Map to binary naming convention
PLATFORM="$OS"
ARCH_NAME="$ARCH"
BINARY_FILE="bin-${ARCH_NAME}-${PLATFORM}"

# Allow optional version argument
VERSION="${1:-$LATEST}"

echo "Installing version: $VERSION - $OS - $ARCH..."

# Download release binary for the specified version
DOWNLOAD_URL="https://github.com/$REPO/releases/download/$VERSION/$BINARY_FILE"

# Install to ~/.local/bin (standard location for user binaries)
INSTALL_DIR="${HOME}/.local/bin"
DEST="${INSTALL_DIR}/${BINARY_NAME}"

# Create installation directory if it doesn't exist
mkdir -p "$INSTALL_DIR"

if ! curl -fsSL "$DOWNLOAD_URL" -o "$DEST"; then
    echo "\nNo binary found for OS '$OS' and architecture '$ARCH'." >&2
    echo "If you believe this is a mistake, please check your release assets or open an issue." >&2
    exit 1
fi
chmod +x "$DEST"

echo "Install complete! Binary installed to: $DEST"
