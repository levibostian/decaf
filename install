#!/usr/bin/env bash
set -euo pipefail

REPO="levibostian/decaf"
BINARY_NAME="decaf"

# Script has a hardcoded version that is checked into version control. 
# If you always run this script from the HEAD of the repo, this will always be the latest version.
# If you checkout a git tag and run, this will be the version of that tag.
LATEST=$(cat version.txt)

# Detect platform
OS=$(uname -s)
ARCH=$(uname -m)

# Map to binary naming convention
PLATFORM="$OS"
ARCH_NAME="$ARCH"
BINARY_FILE="bin-${ARCH_NAME}-${PLATFORM}"

# Allow optional version argument
VERSION="${1:-$LATEST}"

echo "Installing version: $VERSION - $OS - $ARCH..."

# Download release binary for the specified version
DOWNLOAD_URL="https://github.com/$REPO/releases/download/$VERSION/$BINARY_FILE"
DEST="./$BINARY_NAME"

if ! curl -fsSL "$DOWNLOAD_URL" -o "$DEST"; then
    echo "\nNo binary found for OS '$OS' and architecture '$ARCH'." >&2
    echo "If you believe this is a mistake, please check your release assets or open an issue." >&2
    exit 1
fi
chmod +x "$DEST"

echo "Install complete! Run the tool with:"
echo "  ./decaf [args]"
